---
title: "Look for contamination in Gerlinger data"
author: "Roxana Hickey"
date: "November 4, 2015"
output: html_document
---

Adapted from analysis by James Meadow for human microbial cloud study (original script [here](https://github.com/jfmeadow/Meadow_HumanMicrobialCloud_Analysis/blob/master/manuscript_code/contamination/pb_contamination.md)).

Load data.
```{r}
setwd('~/Documents/projects/gerlinger/')

library(vegan)
library(labdsv)

source('code/meadow_pb_functions.R')
```

```{r}
## read in the genus-level OTU table
ger <- read.table('data/tax_16S_uparse/count_tables/gerlinger_uparse_merged_taxonomy_summaries/gerlinger_uparse_merged_L6.txt',
                    header = TRUE, sep = '\t', row.names = 1, comment.char = '', skip = 1)
ger <- t(ger)

colnames(ger) <- gsub('k__', '', colnames(ger))
colnames(ger) <- gsub('p__', '', colnames(ger))
colnames(ger) <- gsub('c__', '', colnames(ger))
colnames(ger) <- gsub('o__', '', colnames(ger))
colnames(ger) <- gsub('f__', '', colnames(ger))
colnames(ger) <- gsub('g__', '', colnames(ger))

ger.tax <- colnames(ger)

## read in mapping file with metadata
ger.map.orig <- read.table('data/map_files/151028_map_edit_finalchems_crack_plus.txt',
                           header = TRUE, sep = '\t', row.names = 1, comment.char = '')
ger.map.orig$SampleID <- row.names(ger.map.orig)

## reduce mapping file to oneuL samples
ger.map <- ger.map.orig[grep('oneuL', row.names(ger.map.orig)), ]

## define samples to ignore due to low read count or from another study
sample.ignore <- c('oneuL3031',
                   row.names(ger)[grep('oneuLP', row.names(ger))],
                   row.names(ger)[grep('oneuLC', row.names(ger))],
                   row.names(ger)[grep('oneuLFT', row.names(ger))])

## make reduced OTU table
ger <- ger[!(row.names(ger) %in% sample.ignore),]

## make reduced mapping table
ger.map <- ger.map[!(row.names(ger.map) %in% sample.ignore),]

## check that all sample names match
all(row.names(ger.map) %in% row.names(ger))

dim(ger.map)
dim(ger)

## reorder map to match OTU table
ger.map <- ger.map[row.names(ger), ]
identical(row.names(ger), row.names(ger.map))

## see how many taxa there are
length(ger.tax)
```

Take out plant and mitochondrial sequences
```{r}
plants <- grep('Chloroplast', ger.tax, ignore.case = TRUE)
mito <- grep('mitochondria', ger.tax, ignore.case = TRUE)
ger <- ger[, -c(plants, mito)]
ger.tax <- ger.tax[-c(plants, mito)] # remove from taxonomy to line up
```

Make a full rarefied dataset including control and contaminants
```{r}
sort(rowSums(ger))

ger.10K <- rrarefy(ger, 10000)

dim(ger.10K)
dim(ger.map)

identical(row.names(ger.10K), row.names(ger.map))
```

Make taxonomy data frame for indexing.
```{r}
taxo <- makeTaxo(ger.tax, ger.10K)
head(taxo)
```

Get rid of empty OTUs to reduce computing demand.
```{r}
ger.10K <- ger.10K[, -which(colSums(ger.10K) == 0)]
taxo <- taxo[colnames(ger.10K), ]
head(taxo)

dim(taxo)
dim(ger.10K)

identical(row.names(taxo), colnames(ger.10K))

## convert to relative abundance
ger.10K.ra <- ger.10K/100
```

Quick reference vector of names for figures and whatnot. Some genus, families, etc are empty, so search for the finest taxonomic level and use that name.
```{r}
consensus <- apply(taxo[, 1:6], 1, cons)
consensus[1:10]
```

Some indexing and metadata stuff for figures and such.
```{r}
ger.map$pch <- 21
table(ger.map$SpaceTypeBioBE)

control <- which(ger.map$SpaceTypeBioBE == 'neg.control')
samples <- which(ger.map$SpaceTypeBioBE != 'neg.control')

spaces <- unique(ger.map$SpaceTypeBioBE)
spaces <- spaces[-11]

spaces.counts <- list()
for(i in 1:length(spaces)){
  spaces.counts[[i]] <- which(ger.map$SpaceTypeBioBE == spaces[i])
  # assign(paste(spaces[i]), which(ger.map$SpaceTypeBioBE == spaces[i])) 
}

ger.map$pch2 <- ger.map$pch
ger.map$pch2[ger.map$SpaceTypeBioBE == 'neg.control'] <- 24

mycol.11 <- c('#A6CEE3', '#1F78B4', '#B2DF8A', '#33A02C', '#FB9A99', '#E31A1C', 
              '#FDBF6F', '#FF7F00', '#CAB2D6', '#6A3D9A', '#B15928')

ger.map$bg <- 'gray60'

for(i in 1:length(spaces)){
  ger.map$bg[spaces.counts[[i]]] <- mycol.11[i]  
}
```

Make dissimilarity matrix; this may take a while. Make with both Canberra and Bray-Curtis, and then make NMDS ordinations. The Bray-Curtis will be more useful for identifying the influence of the most abundant taxa, while Canberra is used for analysis. Here, Canberra has high stress, so is not used much. Also quick plot to make sure that BC captures differences between groups.
```{r}
can <- vegdist(ger.10K, 'canberra')
bc <- vegdist(ger.10K)

nmds.can <- nmds(can)
nmds.bc <- nmds(bc)

plot(nmds.can$points, col = ger.map$SpaceTypeBioBE, type = "n")
points(nmds.can$points[control, ], pch = 17, col = ger.map$bg[control])
for(i in 1:length(spaces)){
  points(nmds.can$points[spaces.counts[[i]], ], 
         pch = 16, col = ger.map$bg[spaces.counts[[i]]])
}

plot(nmds.bc$points, col = ger.map$SpaceTypeBioBE, type = "n")
points(nmds.bc$points[control, ], pch = 17, col = ger.map$bg[control])
for(i in 1:length(spaces)){
  points(nmds.bc$points[spaces.counts[[i]], ], 
         pch = 16, col = ger.map$bg[spaces.counts[[i]]])
}
```

The controls appear to be fairly well separated from the samples (along with a few samples that are in the upper left plot area with the controls), but at first glance no clear differences based on sample type (color) are evident.

Find the most abundant taxa. This is done for 10, 100, 1000. Use 10 for plotting, and take out those contaminants, but use 1000 since some contaminants are really rare in actual samples.
```{r}
## top 10 taxa
control.taxa.10 <- rev(sort(colSums(ger.10K[control, ])))[1:10]/sum(ger.10K[control, ])
sample.taxa.10 <- rev(sort(colSums(ger.10K[-control, ])))[1:10]/sum(ger.10K[-control, ])

control.taxa.10['other'] <- 1 - sum(control.taxa.10)
sample.taxa.10['other'] <- 1 - sum(sample.taxa.10)

top.10 <- cbind(rev(control.taxa.10), rev(sample.taxa.10))
# mids <- barplot(top.10, col = c('gray30', rep('gray70', 10)), border = 'gray30', space = 1)

con.cum.10 <- cumsum(rev(control.taxa.10))
sam.cum.10 <- cumsum(rev(sample.taxa.10))

## top 100
control.taxa.100 <- rev(sort(colSums(ger.10K[control, ])))[1:100]/sum(ger.10K[control, ])
sample.taxa.100 <- rev(sort(colSums(ger.10K[-control, ])))[1:100]/sum(ger.10K[-control, ])

control.taxa.100['other'] <- 1 - sum(control.taxa.100)
sample.taxa.100['other'] <- 1 - sum(sample.taxa.100)

top.100 <- cbind(rev(control.taxa.100), rev(sample.taxa.100))

con.cum.100 <- cumsum(rev(control.taxa.100))
sam.cum.100 <- cumsum(rev(sample.taxa.100))

## top 1000
control.taxa.1000 <- rev(sort(colSums(ger.10K[control, ])))[1:1000]/sum(ger.10K[control, ])
sample.taxa.1000 <- rev(sort(colSums(ger.10K[-control, ])))[1:1000]/sum(ger.10K[-control, ])

control.taxa.1000['other'] <- 1 - sum(control.taxa.1000)
sample.taxa.1000['other'] <- 1 - sum(sample.taxa.1000)

top.1000 <- cbind(rev(control.taxa.1000), rev(sample.taxa.1000))

con.cum.1000 <- cumsum(rev(control.taxa.1000))
sam.cum.1000 <- cumsum(rev(sample.taxa.1000))
```

Halomonas is abundant in both the controls and samples and causes a big jump in the cumulative sum.
```{r}
rev(sort(colSums(ger.10K)))[1:10] # Halomonas is #2 in list
rev(sort(colSums(ger.10K)))[2]/sum(ger.10K) # 5.8%

halo <- grep('Halomonadaceae', row.names(taxo), ignore.case = TRUE) # top Halomonas is #1 in list
taxo[halo, ]

ger.10K[, halo[1]] # only #1 and #4 are prevalent in controls

haloCol <- ger.10K[, halo[1]]

plot(haloCol ~ nmds.bc$points[, 1], type = "n", xlab = 'NMDS 1', ylab = 'Halomonadaceae reads')
points(haloCol[control] ~ nmds.bc$points[control, 1], pch = 21, bg = ger.map$bg[control])
for(i in 1:length(spaces)){
  points(haloCol[spaces.counts[[i]]] ~ nmds.bc$points[spaces.counts[[i]], 1], 
         pch = 16, col = ger.map$bg[spaces.counts[[i]]])
}
```

Although there are 5 OTUs matching 'Halomonadaceae', only one (the first in the halo list) is highly abundant.

Big panel figure showing each top contaminant in the dataset and its influence on NMDS1.
```{r}
pdf('figures/contaminationTop10.pdf', height=10, width=10, useDingbats=TRUE)
layout(matrix(c(11:15, 1:10, 16:20), 5, 4), 
       heights = c(1, 1, 1, 1, 1.5), 
       widths = c(1, 2, 2, 1))
par(las = 1, mar = c(0, 4, 0, 0), fg = "gray40", col.axis = "gray40", col.lab = "gray40")
for (i in 1:10) {
    id <- names(control.taxa.10)[i]
    print(taxo[id, ])
    idCol <- ger.10K.ra[, id]
    print(sum(idCol)/sum(ger.10K.ra))
    y.lim <- round(range(idCol), 2)
    ybuff <- y.lim[2]/8
    x.lim <- round(range(nmds.bc$points[, 1]), 2)
    xbuff <- sum(abs(x.lim))/8

    if (i %in% c(1:4)) {
        par(las = 1, mar = c(0, 4, 0, 0))
    }
    if (i %in% c(5:8)) {
        par(las = 1, mar = c(0, 0, 0, 4))
    }
    if (i == 5) {
        par(las = 1, mar = c(4, 4, 0, 0))
    }
    if (i == 10) {
        par(las = 1, mar = c(4, 0, 0, 4))
    }
    plot(idCol ~ nmds.bc$points[, 1], ylim = c(y.lim + c(-ybuff, 2 * ybuff)), 
        xlim = c(x.lim + c(-xbuff, xbuff)), type = "n", xaxt = "n", yaxt = "n", 
        xlab = "", ylab = "")
    if (i %in% c(1:5)) {
        yax <- 2
    } else {
        yax <- 4
    }
    axis(side = yax, at = y.lim, labels = TRUE)
    if (i %in% c(5, 10)) {
        axis(side = 1, at = x.lim)
        mtext("NMDS 1", side = 1, line = 1, cex = 0.7)
    }
    if (i == 1) {
        mtext("relative\nabundance", side = 2, cex = 0.7, line = 0.5)
    }
    if (i == 6) {
        mtext("relative\nabundance", side = 4, cex = 0.7, line = 0.5)
    }
    points(idCol[control] ~ nmds.bc$points[control, 1], pch = 17, col = ger.map$bg[control])
    for(i in 1:length(spaces)){
      points(idCol[spaces.counts[[i]]] ~ nmds.bc$points[spaces.counts[[i]], 1], 
             pch = 16, col = ger.map$bg[spaces.counts[[i]]])
    }
    # mtext(paste(consensus[id], " (", id, ")", sep = ""), line = -1.5)
    mtext(consensus[id], line = -1.5)
}
dev.off()
```

```{r}
for (i in 11:2) {
    xup <- xdown <- yup <- ydown <- NULL

    yup <- rep(con.cum.10[i], 2)
    ydown <- rep(con.cum.10[i - 1], 2)
    xup <- xdown <- c(1, 2)

    if (names(con.cum.10)[i] %in% names(sam.cum.1000)) {
        ucu <- which(names(sam.cum.1000) == names(con.cum.10)[i])
        yup <- c(yup, rep(sam.cum.1000[ucu], 2))
        ydown <- c(ydown, rep(sam.cum.1000[ucu - 1], 2))
        xup <- xdown <- c(xup, 3, 4)
    }
    if (names(con.cum.10)[i] %in% names(con.cum.1000)) {
        ocu <- which(names(con.cum.1000) == names(con.cum.10)[i])
        yup <- c(yup, rep(con.cum.1000[ocu], 2))
        ydown <- c(ydown, rep(con.cum.1000[ocu - 1], 2))
        xup <- xdown <- c(xup, 5, 6)
    }
    par(mar = c(3, 3, 3, 3))
    if (i %in% c(7, 2)) {
        par(mar = c(8, 3, 3, 3))
    }
    barplot(top.10, col = c("gray30", rep("gray93", 10)), border = "gray30", 
        space = 1, yaxt = "n")
    if (i %in% c(7, 2)) {
        par(las = 2)
        mtext(c("control", "sample"), side = 1, at = c(1.5, 
            3.5), cex = 0.8, line = 0.2)
    }
    par(las = 1)
    if (!i %in% c(7, 2)) {
        par(las = 2)
        mtext(c("c", "s"), side = 1, at = c(1.5, 3.5), cex = 0.8, 
            line = 0.2)
    }
    par(las = 1)
    if (i %in% 11:7) {
        axis(2, at = c(0, 0.5, 1), labels = c(0, 50, 100))
    }
    if (i %in% 2:6) {
        axis(4, at = c(0, 0.5, 1), labels = c(0, 50, 100))
    }
    polygon(c(xup, rev(xdown)), c(yup, rev(ydown)), col = rgb(0, 0, 0, 0.3))
}
```

Now take out those most abundant in pcr controls.
```{r}
dim(ger)

ger.nc <- ger[, -which(colnames(ger) %in% names(control.taxa.10[1]))]

sort(rowSums(ger.nc))

ger.nc.6500 <- rrarefy(ger.nc, 6500)
ger.nc.6500 <- ger.nc.6500[, -which(colSums(ger.nc.6500) == 0)]
ger.6500 <- rrarefy(ger, 6500)
ger.6500 <- ger.6500[, -which(colSums(ger.6500) == 0)]

taxo.nc <- makeTaxo(ger.tax[ger.tax %in% colnames(ger.nc.6500)], ger.nc.6500)
consensus.nc <- apply(taxo.nc[, 1:6], 1, cons)
```

Make same NMDS objects to compare.
```{r}
bc.nc <- vegdist(ger.nc.6500)
bc <- vegdist(ger.6500)

nmds.bc.nc <- nmds(bc.nc)
nmds.bc <- nmds(bc)

plot(nmds.bc.nc$points, type = 'n')
points(nmds.bc.nc$points[control, ], pch = 17, col = ger.map$bg[control])
points(nmds.bc.nc$points[samples, ], pch = 16, col = ger.map$bg[samples])

plot(nmds.bc$points, type = 'n')
points(nmds.bc$points[control, ], pch = 17, col = ger.map$bg[control])
points(nmds.bc$points[samples, ], pch = 16, col = ger.map$bg[samples])

plot(bc.nc, bc)
```

Compare PCoA plots
```{r}
pcoa.bc.nc <- cmdscale(bc.nc, eig = TRUE)
pcoa.bc <- cmdscale(bc, eig = TRUE)

plot(pcoa.bc.nc$points, type = 'n')
points(pcoa.bc.nc$points[control, ], pch = 17, col = ger.map$bg[control])
points(pcoa.bc.nc$points[samples, ], pch = 16, col = ger.map$bg[samples])

plot(pcoa.bc$points, type = 'n')
points(pcoa.bc$points[control, ], pch = 17, col = ger.map$bg[control])
points(pcoa.bc$points[samples, ], pch = 16, col = ger.map$bg[samples])
```

Make tSNE plots (new alternative ordination strategy)
```{r}
tsne.bc.nc <- tsne(bc.nc)
plot(tsne.bc.nc, type = 'n')
points(tsne.bc.nc[control, ], pch = 17, col = ger.map$bg[control])
points(tsne.bc.nc[samples, ], pch = 16, col = ger.map$bg[samples])
```

Run some stats to see if space type explains dissimilarity
```{r}
adonis(bc.nc ~ ger.map$SpaceTypeBioBE)
adonis(bc ~ ger.map$SpaceTypeBioBE)
```

Clean up, save data
```{r}
rm(ger.10K.ra, ger.10K, top.10, top.100, top.1000, can, con.cum.10, con.cum.100, con.cum.1000,
   control.taxa.10, control.taxa.100, control.taxa.1000, halo, haloCol, i, id, idCol, mito, nmds.can,
   ocu, plants, sam.cum.10, sam.cum.100, sam.cum.1000, sample.ignore, sample.taxa.10, sample.taxa.100,
   sample.taxa.1000, spaces.counts, ucu, x.lim, xbuff, xdown, xup, y.lim, yax, ybuff, ydown, yup)
save.image('results/otu_setup/ger_rm_contaminants.RData')
```